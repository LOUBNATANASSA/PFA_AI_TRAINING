<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Risque de Cholest√©rol</title>
    <!-- Ajout de la biblioth√®que html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --medical-blue: #0077b6;
            --medical-red: #d90429;
            --medical-green: #2b9348;
            --medical-yellow: #ffba08;
            --medical-light: #f0f8ff;
        }
        
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: #f0f8ff;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .medical-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 119, 182, 0.1);
            width: 100%;
            max-width: 800px;
            padding: 30px;
            position: relative;
            overflow: hidden;
            border-top: 8px solid var(--medical-blue);
        }

        .medical-card::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 120px;
            height: 120px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%230077b6" opacity="0.1"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.8L20 9v6l-8 4-8-4V9l8-4.2zM12 16l-4-2v-4l4 2 4-2v4l-4 2z"/></svg>');
            background-size: contain;
        }

        .medical-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }

        .medical-icon {
            width: 50px;
            height: 50px;
            background-color: var(--medical-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 24px;
        }

        .risk-gauge {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: conic-gradient(
                var(--medical-green) 0% 20%, 
                var(--medical-yellow) 20% 50%, 
                var(--medical-red) 50% 100%
            );
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 20px auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 8px solid white;
        }

        .risk-gauge::after {
            content: "";
            position: absolute;
            width: 85%;
            height: 85%;
            background: white;
            border-radius: 50%;
        }

        .risk-value {
            position: relative;
            z-index: 2;
            font-size: 42px;
            font-weight: 700;
            color: var(--medical-blue);
        }

        .sticker {
            position: absolute;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            transform: rotate(-5deg);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .sticker-high {
            background-color: var(--medical-red);
            color: white;
            top: 20px;
            right: 20px;
        }

        .sticker-info {
            background-color: var(--medical-blue);
            color: white;
            bottom: 20px;
            left: 20px;
        }

        .advice-section {
            background: var(--medical-light);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            border-left: 5px solid var(--medical-blue);
        }

        .advice-section h3 {
            color: var(--medical-blue);
            display: flex;
            align-items: center;
        }

        .advice-section h3::before {
            content: "üìå";
            margin-right: 10px;
        }

        .retake-btn {
            background: linear-gradient(to right, var(--medical-blue), #00b4d8);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 15px auto;
            box-shadow: 0 4px 10px rgba(0, 119, 182, 0.3);
            transition: all 0.3s;
        }

        .pdf-btn {
            background: linear-gradient(to right, #2b9348, #52b788);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px auto;
            box-shadow: 0 4px 10px rgba(43, 147, 72, 0.3);
            transition: all 0.3s;
            width: 250px;
        }

        .pdf-btn:hover, .retake-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 119, 182, 0.4);
        }

        .button-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        ul {
            padding-left: 20px;
        }

        li {
            margin-bottom: 10px;
            position: relative;
            padding-left: 25px;
        }

        li::before {
            content: "‚ù§Ô∏è";
            position: absolute;
            left: 0;
        }
        
        .user-info {
            text-align: right;
            font-size: 0.9em;
            color: #777;
            margin-top: 20px;
        }
        
        /* Position de l'aiguille sur le cadran */
        .needle-container {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 3;
            display: flex;
            justify-content: center;
        }
        
        .needle {
            position: absolute;
            width: 3px;
            height: 85px;
            background-color: black;
            transform-origin: bottom center;
            transform: rotate(0deg);
            bottom: 50%;
            border-radius: 3px;
            z-index: 3;
            transition: transform 1.5s cubic-bezier(0.25, 0.1, 0.25, 1.4);
        }
        
        .needle::after {
            content: "";
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: black;
            border-radius: 50%;
            bottom: -4px;
            left: -3.5px;
        }

        /* Style pour l'impression/PDF */
        @media print {
            body {
                background-color: white;
                padding: 0;
                margin: 0;
            }
            
            .medical-card {
                box-shadow: none;
                max-width: 100%;
                padding: 20px;
            }
            
            .retake-btn, .pdf-btn {
                display: none;
            }
            
            .pdf-header {
                display: block !important;
            }
        }
        
        .pdf-header {
            display: none;
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }

        .pdf-footer {
            display: none;
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
    </style>
</head>
<body>
    <div id="content-to-pdf">
        <!-- En-t√™te PDF qui appara√Æt uniquement dans le PDF -->
        <div class="pdf-header">
            <h2>RAPPORT M√âDICAL CONFIDENTIEL</h2>
            <p>√âvaluation du risque d'hypercholest√©rol√©mie familiale</p>
        </div>

        <div class="medical-card">
            <div class="sticker sticker-high">RISQUE</div>
            <div class="sticker sticker-info">CHOLEST√âROL</div>

            <div class="medical-header">
                <div class="medical-icon">‚ù§Ô∏è</div>
                <h1>√âvaluation du Risque d'Hypercholest√©rol√©mie</h1>
            </div>

            <div style="text-align: center;">
                <h2 id="risk-title">Analyse en cours...</h2>
                <p>Probabilit√© estim√©e</p>
                
                <div class="risk-gauge">
                    <div class="needle-container">
                        <div class="needle" id="risk-needle"></div>
                    </div>
                    <div class="risk-value" id="risk-percentage">0%</div>
                </div>
                
                <div id="risk-level" style="font-weight: bold; color: var(--medical-blue);"></div>
            </div>

            <div class="advice-section">
                <h3>Recommandations m√©dicales</h3>
                <ul id="advice-list">
                    <li>Calcul des recommandations en cours...</li>
                </ul>
            </div>

            <div class="button-container">
                <button class="retake-btn" onclick="window.location.href='/formulaire_hypercholesterolemia/'">
                  üîÑ Nouvelle √âvaluation
                </button>
                <button class="retake-btn" onclick="window.location.href='/'">
                  üè† Retour √† la page principale
                </button>
                <button class="pdf-btn" onclick="generatePDF()">
                  üìÑ T√©l√©charger Rapport PDF
                </button>
            </div>
            
            <div class="user-info">
                
              
            </div>
        </div>
        
        <!-- Pied de page PDF qui appara√Æt uniquement dans le PDF -->
        <div class="pdf-footer">
            <p>Ce document est g√©n√©r√© automatiquement et ne constitue pas un diagnostic m√©dical.</p>
            <p>Veuillez consulter un professionnel de sant√© pour une interpr√©tation personnalis√©e de ces r√©sultats.</p>
            <p>¬© 2025 Syst√®me d'√âvaluation des Risques M√©dicaux</p>
        </div>
    </div>

    <script>
    // Fonction pour g√©n√©rer le PDF
    function generatePDF() {
        // Afficher les √©l√©ments sp√©cifiques au PDF
        document.querySelector('.pdf-header').style.display = 'block';
        document.querySelector('.pdf-footer').style.display = 'block';
        
        // Configuration de html2pdf
        const options = {
            margin: 10,
            filename: 'Rapport_Cholesterol.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        
        // G√©n√©rer le PDF
        html2pdf().set(options).from(document.getElementById('content-to-pdf')).save().then(() => {
            // Cacher √† nouveau les √©l√©ments sp√©cifiques au PDF apr√®s g√©n√©ration
            document.querySelector('.pdf-header').style.display = 'none';
            document.querySelector('.pdf-footer').style.display = 'none';
        });
    }
    
    // Fonction pour calculer la rotation de l'aiguille selon le risque
    function setNeedlePosition(risk) {
        // Convertir le risque (0-100) en degr√©s (-90 √† 90)
        // -90 degr√©s = 0% de risque, 90 degr√©s = 100% de risque
        const degrees = -90 + (risk * 1.8);
        document.getElementById('risk-needle').style.transform = `rotate(${degrees}deg)`;
    }
    
    function fetchAndProcessData() {
        fetch('/get-cholesterol-results/')
            .then(response => response.json())
            .then(data => {
                console.log("Donn√©es re√ßues:", data);

                // V√©rifier qu'il y a au moins un r√©sultat
                if (data.results && data.results.length > 0) {
                    // Prendre le dernier r√©sultat
                    const lastResult = data.results[data.results.length - 1];
                    try {
                        // V√©rifier si responses est une cha√Æne ou un objet
                        let dataDict;
                        if (typeof lastResult.responses === 'string') {
                            dataDict = JSON.parse(lastResult.responses);
                        } else {
                            dataDict = lastResult.responses; // D√©j√† un objet
                        }
                        
                        console.log("Contenu de dataDict:", dataDict);
                        console.log("Structure compl√®te:", JSON.stringify(dataDict, null, 2));

                        const risk = processHFDataUpdated(dataDict);
                        
                        // Mettre √† jour l'interface utilisateur
                        document.getElementById("risk-percentage").innerText = `${risk}%`;
                        document.getElementById("risk-title").innerText = "R√©sultat de l'√©valuation";
                        
                        // D√©terminer le niveau de risque
                        let riskLevel = "";
                        let riskColor = "";
                        let recommendations = [];
                        
                        // Configurer la position de l'aiguille
                        setNeedlePosition(risk);
                        
                        if (risk < 20) {
                            riskLevel = "Risque Faible";
                            riskColor = "var(--medical-green)";
                            recommendations = [
                                "Maintenez une alimentation √©quilibr√©e pauvre en graisses satur√©es",
                                "Pratiquez une activit√© physique r√©guli√®re (30 minutes par jour)",
                                "Continuez √† surveiller votre taux de cholest√©rol tous les 5 ans"
                            ];
                        } else if (risk < 40) {
                            riskLevel = "Risque Mod√©r√©";
                            riskColor = "var(--medical-yellow)";
                            recommendations = [
                                "R√©duisez votre consommation de graisses animales et d'aliments transform√©s",
                                "Augmentez votre consommation de fibres (fruits, l√©gumes, c√©r√©ales compl√®tes)",
                                "Faites de l'exercice r√©guli√®rement (45 minutes, 4-5 fois par semaine)",
                                "Contr√¥lez votre taux de cholest√©rol tous les 2 ans"
                            ];
                        } else if (risk < 70) {
                            riskLevel = "Risque √âlev√©";
                            riskColor = "var(--medical-red)";
                            recommendations = [
                                "Consultez un sp√©cialiste pour √©valuer votre profil lipidique complet",
                                "Suivez un r√©gime m√©diterran√©en strict",
                                "√âvitez compl√®tement les aliments riches en cholest√©rol et en graisses satur√©es",
                                "Augmentez votre activit√© physique sous supervision m√©dicale",
                                "Discutez avec votre m√©decin de l'opportunit√© d'un traitement m√©dicamenteux"
                            ];
                        } else {
                            riskLevel = "Risque Tr√®s √âlev√©";
                            riskColor = "darkred";
                            recommendations = [
                                "Consultez d'urgence un cardiologue ou un sp√©cialiste en lipidologie",
                                "Un traitement m√©dicamenteux est probablement n√©cessaire",
                                "Suivez un r√©gime strict sous supervision d'un nutritionniste",
                                "Contr√¥lez r√©guli√®rement vos niveaux de LDL, HDL et triglyc√©rides",
                                "√âvaluez les autres facteurs de risque cardiovasculaire"
                            ];
                        }
                        
                        // Mettre √† jour l'interface avec le niveau de risque
                        const riskLevelElement = document.getElementById("risk-level");
                        riskLevelElement.innerText = riskLevel;
                        riskLevelElement.style.color = riskColor;
                        
                        // Mettre √† jour les recommandations
                        const adviceList = document.getElementById("advice-list");
                        adviceList.innerHTML = '';
                        
                        recommendations.forEach(recommendation => {
                            const li = document.createElement('li');
                            li.textContent = recommendation;
                            adviceList.appendChild(li);
                        });
                        
                    } catch (error) {
                        console.error("Erreur de traitement:", error);
                        document.getElementById("risk-title").innerText = "Erreur de traitement";
                        document.getElementById("risk-percentage").innerText = "Err";
                    }
                } else {
                    console.error("Aucun r√©sultat trouv√© dans les donn√©es.");
                    document.getElementById("risk-title").innerText = "Aucun r√©sultat";
                    document.getElementById("risk-percentage").innerText = "N/A";
                }
            })
            .catch(error => {
                console.error("Erreur:", error);
                document.getElementById("risk-title").innerText = "Erreur de connexion";
                document.getElementById("risk-percentage").innerText = "Err";
            });
    }

    // Fonction adapt√©e √† la structure r√©elle des donn√©es
    function processHFDataUpdated(dataDict) {
        let risk = 10;
        console.log("Traitement des donn√©es avec la fonction mise √† jour:", dataDict);

        // 1. Ant√©c√©dents familiaux
        if (dataDict.parentCholesterol === "yes") {
            risk += 15;
            console.log("Ajout√© 15 pour parentCholesterol");
        }
        if (dataDict.familyCholesterol === "yes") {
            risk += 25;
            console.log("Ajout√© 25 pour familyCholesterol");
        }
        if (dataDict.familyHeartCondition === "yes") {
            risk += 10;
            console.log("Ajout√© 10 pour familyHeartCondition");
        }
        if (dataDict.cardiacDeath === "yes") {
            risk += 5;
            console.log("Ajout√© 5 pour cardiacDeath");
        }

        // 2. R√©sultats biologiques
        let ldl = NaN;
        if (dataDict.ldlValue && !isNaN(parseFloat(dataDict.ldlValue))) {
            ldl = parseFloat(dataDict.ldlValue);
        }
        
        console.log("Valeur LDL:", ldl);
        if (!isNaN(ldl)) {
            if (ldl > 190) {
                risk += 30;
                console.log("Ajout√© 30 pour LDL > 190");
            } else if (ldl > 130) {
                risk += 20;
                console.log("Ajout√© 20 pour LDL > 130");
            } else if (ldl > 100) {
                risk += 10;
                console.log("Ajout√© 10 pour LDL > 100");
            }
        }

        if (dataDict.toldHighCholesterol === "yes") {
            risk += 10;
            console.log("Ajout√© 10 pour toldHighCholesterol");
        }
        if (dataDict.statins === "yes") {
            risk += 5;
            console.log("Ajout√© 5 pour statins");
        }

        // 3. Signes physiques
        if (dataDict.xanthelasmas === "yes") {
            risk += 10;
            console.log("Ajout√© 10 pour xanthelasmas");
        }
        if (dataDict.yellowNodules === "yes") {
            risk += 15;
            console.log("Ajout√© 15 pour yellowNodules");
        }
        if (dataDict.cornealArch === "yes") {
            risk += 5;
            console.log("Ajout√© 5 pour cornealArch");
        }

        // 4. Facteurs li√©s au mode de vie
        if (dataDict.smoke === "yes") {
            risk += 5;
            console.log("Ajout√© 5 pour smoke");
        }
        if (dataDict.diabetesHypertension === "yes") {
            risk += 5;
            console.log("Ajout√© 5 pour diabetesHypertension");
        }
        if (dataDict.bmi === "yes") {
            risk += 5;
            console.log("Ajout√© 5 pour bmi");
        }

        // 5. D√©j√† diagnostiqu√© - Adapt√© selon vos donn√©es
        if (dataDict.allChildrenSick === "yes" || dataDict.oneChildSick === "yes") {
            console.log("Diagnostique familial pr√©sent - Risque √©lev√©");
            risk += 15;
        }

        console.log("Risque total calcul√©:", risk);
        return risk;
    }

    // Appel de la fonction au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        fetchAndProcessData();
    });
    </script>
</body>
</html>